# ADR-20260220: 에셋 관계 모델 확장

## Status

**Accepted** (2026-02-20)

## Context

Factory MES를 활용하려 할 때, 에셋(공장/회사 자원) 간의 관계를 다음처럼 다룰 수 있어야 한다.

- **관계의 종류**: 예) "공급한다", "포함한다", "위치한다"
- **방향**: A→B vs B→A 명시
- **관계에 붙는 속성**: 유량, 용량, 거리 등

현재 모델은 `Asset.Connections`가 `IReadOnlyList<string>`(연결된 에셋 ID 목록)만 지원한다.  
관계 타입·방향·엣지 속성을 표현할 수 없어, 시뮬레이션·그래프 분석 시 의미를 부여하기 어렵다.

## Decision

**에셋 간 관계를 first-class로 다루기 위해, 관계를 별도 엔티티(컬렉션)로 두는 방식을 채택한다.**

### 모델

- **관계 엔티티(Relationship / Edge)**

  - `fromAssetId`, `toAssetId`: 방향 명시.
  - `relationshipType` (또는 `type`): 관계 종류(예: `feeds_into`, `contains`, `located_in`).
  - `properties` (또는 `metadata`): 관계 단위 속성(자유 객체).
  - 필요 시 `createdAt`/`updatedAt` 등 공통 필드.

- **기존 `Asset.Connections`**
  - 단기: 유지 가능(하위 호환·단순 목록 조회용).
  - 장기: 관계 컬렉션에서 파생해 채우거나, 점진적으로 deprecated 후 "관계 목록 API"로 대체 가능.

### 저장소·API

- MongoDB: `relationships`(또는 `edges`) 컬렉션 추가.
  - 인덱스: `fromAssetId`, `toAssetId`, `relationshipType`, 필요 시 복합 인덱스.
- Backend: Relationship 도메인·Repository·CRUD(또는 최소 Create/Read) API 추가.
- `shared/api-schemas`: Relationship DTO 및 경로 정의.

### 시뮬레이션·파이프라인

- 시뮬레이션 엔진(Backend) 및 파이프라인은 에셋 목록 + 관계 목록을 조회해 그래프로 사용할 수 있다.
- 관계 타입·속성에 따라 "유량 전파", "포함 트리 순회" 등 시뮬레이션 로직을 구체화할 수 있다.

## Consequences

### 긍정적

- 관계 종류·방향·관계 단위 속성을 명시적으로 저장·조회·시뮬레이션에 활용 가능.
- 그래프 기반 분석·시뮬레이션 설계가 단순해짐.
- 기존 에셋 CRUD와 독립적으로 관계 API를 확장할 수 있음.

### 부정적 및 완화

- **스키마·API 변경**: 새 컬렉션·엔드포인트 추가.
  - 완화: 기존 `Asset.Connections`는 당분간 유지해 마이그레이션 부담을 나눌 수 있음.
- **일관성**: 에셋 삭제 시 해당 관계 정리 정책 필요.
  - 완화: 애플리케이션 레벨에서 cascade 또는 정기 정리로 처리.

## 참고

- [개발 계획 (2026-02-20)](../planning/2026-02-20-development-plan.md)
- [infrastructure/mongo/MODEL.md](../../infrastructure/mongo/MODEL.md)
