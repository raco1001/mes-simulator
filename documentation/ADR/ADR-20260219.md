# ADR-20260219: MVP 구현 완료 및 Docker Compose 통합

## Status

**Accepted** (2026-02-19)

## Context

Factory MES MVP의 핵심 시나리오 **「이벤트 수신 → Kafka → Pipeline 처리 → MongoDB 저장 → Backend 조회 → UI 표시」** 를 완료하고, 동일 흐름을 Docker Compose로 통합 테스트할 수 있도록 하는 것이 목표였습니다.

### 구현 전 상태

- Event Schema, Topic 정의는 계획만 존재
- MongoDB 모델·컬렉션 초기화 미정
- Pipeline Asset Worker, Backend Asset/State API, Frontend Asset 리스트 미구현
- Docker는 인프라(Kafka, MongoDB, Redis)만 compose로 관리, 앱 서비스는 로컬 실행 전제

### 요구 사항

- `MVP-PLAN.md`의 STEP 1~6 순서대로 구현
- API 규약은 `shared/api-schemas`에 정의하고 Backend/Frontend가 준수
- 인프라가 이미 기동 중인 환경에서 Backend·Frontend·Pipeline을 Docker로 띄워 E2E 검증

## Decision

### 1. 공유 API 스키마 및 인프라

- **`shared/api-schemas/assets.json`**: AssetDto·StateDto 정의 및 `GET /api/assets`, `/api/assets/{id}`, `/api/states`, `/api/states/{assetId}` 규약 명시
- **`shared/event-schemas`**: asset.created, asset.health.updated, alert.generated 스키마 및 topics 정의
- **인프라**: `docker/docker-compose.infra.yml`로 Kafka(Zookeeper, Broker, UI), MongoDB(Mongo Express), Redis(Redis Commander) 단일 네트워크(`factory-network`)에서 관리

### 2. Backend (DotnetEngine)

- **라우트**: `[Route("api/[controller]")]`는 URL이 PascalCase(`/api/Asset`, `/api/State`)가 되어 프론트/스키마와 불일치하므로, **명시 라우트**로 통일
  - AssetController: `[Route("api/assets")]`
  - StateController: `[Route("api/states")]`
- **CORS**: Development에서 AllowAnyOrigin, Production에서 특정 Origin만 허용하도록 `Program.cs`에 추가
- **MongoDB**: ConnectionStrings__MongoDB를 compose/환경변수로 주입, `IAssetRepository` → `MongoAssetRepository`로 assets/states 조회
- **문서화**: Swashbuckle(Swagger) 추가, Development에서만 Swagger UI 노출

### 3. Frontend (Vite + React)

- **API 클라이언트**: `shared/api/types.ts`, `apiClient.ts`에서 `shared/api-schemas` 규약에 맞게 getAssets, getStates 등 구현, `VITE_API_BASE_URL`로 백엔드 주소 설정
- **화면**: Asset 리스트 페이지(AssetList.tsx)에서 assets·states 조합 후 테이블로 표시, 상태별 색상(정상/경고/오류)
- **테스트**: Vitest + React Testing Library, `@vitest/ui`는 vitest 4와 버전 맞춤(^4.0.18)
- **Docker**: 빌드 시 `VITE_API_BASE_URL=http://localhost:5000` 주입, nginx로 정적 서빙(SPA fallback)

### 4. Pipeline (Python)

- **Asset Worker**: `pipeline-asset-worker` 진입점, Kafka `factory.asset.events` consume → asset.created / asset.health.updated 처리 → 상태 계산 후 MongoDB(assets, events, states) 저장
- **설정**: `src/config/settings.py`에서 `PIPELINE_*` 환경변수로 Kafka·MongoDB 주소 등 주입
- **Docker**: `servers/pipeline/Dockerfile`에서 `pyproject.toml`·`src/` 복사 후 `pip install .`, ENTRYPOINT `pipeline-asset-worker`

### 5. Docker Compose 앱 스택

- **`docker/docker-compose.app.yml`**: Backend, Frontend, Pipeline 서비스만 정의
  - **네트워크**: `factory-network`를 **external**로 사용 → 이미 떠 있는 인프라와 동일 네트워크
  - **Backend**: MongoDB URL `mongodb://admin:admin123@mongodb:27017/factory_mes?authSource=admin`, healthcheck `GET /api/health`
  - **Frontend**: Backend health 통과 후 기동, 포트 5173→80
  - **Pipeline**: `PIPELINE_KAFKA_BOOTSTRAP_SERVERS=kafka:9093`, `PIPELINE_MONGODB_URL=mongodb://...@mongodb:27017/...`, restart: unless-stopped
- **Dockerfile**
  - Backend: `servers/backend` 컨텍스트, `DotnetEngine/Dockerfile` — net10.0, publish 후 curl 포함 런타임
  - Frontend: `servers/frontend` — npm install, `npm run build`, nginx 서빙
  - Pipeline: `servers/pipeline` — Python 3.12-slim, `pip install .`, `pipeline-asset-worker`
- **통합 테스트**: `docker/scripts/integration-test.sh`에서 factory-network 확인 → app 빌드·up → Backend health 대기 → `/api/health`, `/api/assets`, `/api/states` 호출 검증

## Consequences

### 긍정적 영향

- MVP 흐름이 Event Schema → MongoDB 모델 → Pipeline → Backend API → Frontend까지 한 번에 검증 가능
- API 규약을 `shared/api-schemas`에 두어 Backend/Frontend가 동일 스키마를 따름
- 인프라는 그대로 두고 앱만 `docker compose -f docker-compose.app.yml up -d`로 띄워 통합 테스트 가능
- Backend 라우트를 소문자·복수(`/api/assets`, `/api/states`)로 통일해 프론트·문서와 일치

### 부정적 영향 및 완화

- **컨테이너 이름 충돌**: 기존에 수동으로 띄운 `/backend` 등과 이름이 겹치면 Conflict 발생  
  - **완화**: `docker compose -f docker-compose.app.yml down` 후 재기동, 또는 기존 컨테이너 제거 후 up
- **Frontend 의존성**: vitest 4와 @vitest/ui 2 조합에서 ERESOLVE 발생  
  - **완화**: package.json에서 `@vitest/ui`를 `^4.0.18`로 상향하여 peer 호환

### 현재 구현 상태 요약

| 구분 | 내용 |
|------|------|
| Event Schema | shared/event-schemas (asset.created, asset.health.updated, alert.generated, topics) |
| API Schema | shared/api-schemas/assets.json (AssetDto, StateDto, paths) |
| MongoDB | factory_mes DB, assets/events/states 컬렉션, init 스크립트 |
| Pipeline | asset_worker, Kafka consumer, 상태 계산, Mongo 저장, Dockerfile |
| Backend | Asset/State API, CORS, Swagger, MongoAssetRepository, Dockerfile |
| Frontend | AssetList, apiClient, Vitest+RTL, Dockerfile(nginx) |
| Docker | docker-compose.infra.yml, docker-compose.app.yml(backend, frontend, pipeline), integration-test.sh |

## 참고

- [MVP-PLAN.md](../../MVP-PLAN.md)
- [docker/README.md](../../docker/README.md)
- [shared/api-schemas/README.md](../../shared/api-schemas/README.md)
- [servers/backend/README.md](../../servers/backend/README.md)
- [servers/frontend/README.md](../../servers/frontend/README.md)
- [infrastructure/mongo/MODEL.md](../../infrastructure/mongo/MODEL.md)
